#!/usr/bin/env python

"""
Kippo-Malware is a script to download and save all malicious files from a Kippo SSH honeypot database.
Website: http://bruteforce.gr/kippo-malware
Author: ikoniaris
"""

import sys
import os
import re
import requests
from clint.textui import progress, colored
from pony.orm import *
from helper import *


class KippoMalware:
    def __init__(self, args):
        """
        Initializes object
        """
        self.args = args
        self.urls = []
        self.db = self.connect_to_db()

    def connect_to_db(self):
        """
        Setups database connection
        """
        try:
            db = Database('mysql', host=self.args.hostname, port=self.args.port, user=self.args.username,
                          passwd=self.args.password, db=self.args.database)
            return db
        except DatabaseError:
            print colored.red(
                "\nERROR => Could not connect to MySQL server. Exiting...")
            print "\nPlease run the program with '-h' parameter for help."
            sys.exit(1)

    def get_urls(self):
        """
        Fetches URLs from the Kippo database.
        """
        with db_session:
            urls = self.db.select(
                "SELECT DISTINCT TRIM(LEADING 'wget' FROM LOWER(input)) "
                "FROM input "
                "WHERE input LIKE 'wget%' AND input != 'wget' "
                "ORDER BY timestamp DESC")

            self.urls = normalize_urls(urls)

            if self.args.debug:
                print_urls(self.urls)

    def download_malware(self):
        """
        Downloads files from previously fetched URL list.
        """
        #Setup download directory
        if not os.path.exists(self.args.directory):
            try:
                os.makedirs(self.args.directory)
            except IOError:
                print colored.red("\nERROR => Could not create download directory. Exiting...")
                sys.exit(1)
        else:
            print colored.yellow("\nWARNING => Download directory exists. Files will be overwritten.")

        #Setup proxy and user agent (if given)
        proxies, headers = {}, {}
        if self.args.proxy:
            proxies = {
                "http": self.args.proxy,
                "https": self.args.proxy,
                "ftp": self.args.proxy
            }
        if self.args.user_agent:
            headers = {'User-Agent': self.args.user_agent}

        #Download files
        counter = 1
        for url in self.urls:
            file_name = self.args.directory + os.path.sep + url.split("/")[-1]
            file_name = re.sub('[!,;\[\]()*?\'"<>|]', '_', file_name)
            try:
                r = requests.get(url, stream=True, headers=headers, proxies=proxies, verify=False)
                r.raise_for_status()

                if r.headers['Content-Type'].split('/')[0] == "text":
                    raise TypeError

                total_length = int(r.headers['Content-Length'])
                if total_length:
                    try:
                        with open(file_name, 'wb') as f:
                            print colored.green("\n%d. Downloading: %s" % (counter, url))
                            for chunk in progress.bar(r.iter_content(chunk_size=1024),
                                                      expected_size=(total_length / 1024) + 1):
                                if chunk:
                                    f.write(chunk)
                                    f.flush()
                    except EnvironmentError:
                        print colored.red("\n%d. ERROR => Could not write file to download directory." % counter)
            except (requests.RequestException, StandardError):
                if self.args.debug:
                    print colored.yellow("\n%d. WARNING => Error while downloading: %s" % (counter, url))
            finally:
                counter += 1


def main():
    args = parse_arguments()
    downloader = KippoMalware(args)
    downloader.get_urls()
    downloader.download_malware()
    print colored.cyan("\nINFO => Downloading ended. The files have been stored at: %s" % args.directory)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print colored.cyan("\nINFO => Caught keyboard interrupt. Exiting...")
        sys.exit(1)